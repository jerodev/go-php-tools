name: Laravel testing

on:
  push:
    branches: 
      - master
  pull_request:

jobs:
  test:
    name: Redis Queue Test
    runs-on: ubuntu-latest
    timeout-minutes: 4

    services:
      redis:
        image: redis
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Checkout Laravel
        uses: actions/checkout@v4
        with:
          repository: 'laravel/laravel'
          ref: '11.x'
          path: 'laratest'

      - name: Setup Laravel
        run: |
            cp laratest/.env.example laratest/.env
            sed -i 's/APP_NAME=Laravel/APP_NAME=LaraQueue/' laratest/.env
            sed -i 's/APP_KEY=/APP_KEY=abc123/' laratest/.env
            sed -i 's/QUEUE_CONNECTION=database/QUEUE_CONNECTION=redis/' laratest/.env
            mkdir laratest/app/Jobs
            cp testscripts/laravel/LaravelTestJob.php laratest/app/Jobs/LaravelTestJob.php

      - uses: actions/setup-go@v5
        with:
          go-version: '^1.22'
          cache: false
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: 8.3
          coverage: none
          extensions: redis
          tools: composer:v2

      - name: Install dependencies
        run: cd laratest && composer install --no-interaction

      - name: Queue & Handle
        run: |
            php laratest/artisan queue:work --once &
            go run testscripts/laravel/queue.go
            sleep 5s
            cat laratest/app/Jobs/foo_bar

      - name: Dump Laravel logs
        if: failure()
        run: cat laratest/storage/logs/laravel.log

